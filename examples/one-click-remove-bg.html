<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="钱猎献" />
    <title>一键抠图</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f5f7fb;
        --bg-dark: #1f2933;
        --card: rgba(255, 255, 255, 0.9);
        --card-dark: rgba(31, 41, 51, 0.9);
        --primary: #4f46e5;
        --text: #1f2933;
        --text-dark: #e5e7eb;
        --muted: #6b7280;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: linear-gradient(160deg, var(--bg), #dbeafe);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      @media (prefers-color-scheme: dark) {
        body {
          background: linear-gradient(160deg, var(--bg-dark), #111827);
          color: var(--text-dark);
        }
      }

      header {
        max-width: 960px;
        padding: 64px 24px 24px;
        text-align: center;
      }

      h1 {
        font-size: 3rem;
        margin-bottom: 16px;
        letter-spacing: 0.08em;
      }

      p.subtitle {
        font-size: 1.15rem;
        color: var(--muted);
        margin: 0 auto 32px;
        max-width: 520px;
      }

      .config-note {
        margin: -8px auto 24px;
        font-size: 0.9rem;
        max-width: 640px;
        color: var(--muted);
      }

      .config-note code {
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", Menlo, monospace;
        background: rgba(148, 163, 184, 0.18);
        padding: 2px 6px;
        border-radius: 6px;
      }

      .model-selector {
        margin: 0 auto 32px;
        padding: 16px 20px;
        border-radius: 18px;
        background: var(--card);
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
        display: inline-flex;
        align-items: center;
        gap: 16px;
      }

      @media (prefers-color-scheme: dark) {
        .model-selector {
          background: var(--card-dark);
          box-shadow: 0 12px 32px rgba(17, 24, 39, 0.6);
          color: var(--text-dark);
        }
      }

      .model-selector .current-model-label {
        font-weight: 600;
      }

      .model-selector button {
        padding: 8px 18px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .model-selector button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
      }

      .drop-area {
        width: min(90vw, 640px);
        min-height: 240px;
        border: 2px dashed rgba(79, 70, 229, 0.4);
        border-radius: 24px;
        padding: 48px 24px;
        background: var(--card);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: 16px;
        transition: transform 0.3s ease, border-color 0.3s ease,
          box-shadow 0.3s ease;
        cursor: pointer;
      }

      @media (prefers-color-scheme: dark) {
        .drop-area {
          background: var(--card-dark);
          border-color: rgba(129, 140, 248, 0.4);
        }
      }

      .drop-area.dragover {
        transform: translateY(-6px);
        border-color: rgba(79, 70, 229, 0.8);
        box-shadow: 0 18px 40px rgba(79, 70, 229, 0.2);
      }

      .drop-area svg {
        width: 64px;
        height: 64px;
        fill: var(--primary);
      }

      .drop-area .hint {
        font-size: 1.05rem;
        font-weight: 600;
      }

      .drop-area .tip {
        color: var(--muted);
        font-size: 0.95rem;
      }

      input[type="file"] {
        display: none;
      }

      .task-list {
        margin: 40px 0 80px;
        width: min(90vw, 720px);
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .task-item {
        background: var(--card);
        border-radius: 20px;
        padding: 20px 24px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      @media (prefers-color-scheme: dark) {
        .task-item {
          background: var(--card-dark);
          box-shadow: 0 10px 30px rgba(17, 24, 39, 0.6);
        }
      }

      .task-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .task-name {
        font-weight: 600;
        word-break: break-all;
      }

      .task-status {
        font-size: 0.9rem;
        color: var(--muted);
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.1);
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        transition: width 0.2s ease;
      }

      .download-link {
        align-self: flex-end;
        background: var(--primary);
        color: #fff;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }

      .download-link.visible {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .model-dialog {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(6px);
        padding: 24px;
        z-index: 100;
      }

      .model-dialog.visible {
        display: flex;
      }

      .model-dialog__card {
        width: min(640px, 90vw);
        max-height: min(520px, 90vh);
        overflow: hidden;
        border-radius: 24px;
        background: var(--card);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
        display: flex;
        flex-direction: column;
      }

      @media (prefers-color-scheme: dark) {
        .model-dialog__card {
          background: var(--card-dark);
          box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
        }
      }

      .model-dialog__header {
        padding: 24px 28px 0;
        text-align: left;
      }

      .model-dialog__body {
        padding: 16px 28px 0;
        overflow-y: auto;
      }

      .model-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }

      .model-card {
        position: relative;
        border: 1px solid rgba(99, 102, 241, 0.12);
        border-radius: 18px;
        padding: 18px;
        text-align: left;
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease,
          box-shadow 0.2s ease;
        background: rgba(255, 255, 255, 0.6);
      }

      @media (prefers-color-scheme: dark) {
        .model-card {
          background: rgba(31, 41, 55, 0.6);
          border-color: rgba(129, 140, 248, 0.12);
          color: var(--text-dark);
        }
      }

      .model-card:hover,
      .model-card[data-selected="true"] {
        transform: translateY(-3px);
        border-color: rgba(79, 70, 229, 0.6);
        box-shadow: 0 16px 32px rgba(79, 70, 229, 0.18);
      }

      .model-card__name {
        font-weight: 700;
        margin-bottom: 8px;
      }

      .model-card__desc {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .model-card__tooltip {
        position: absolute;
        inset: auto 12px 12px 12px;
        border-radius: 12px;
        background: rgba(30, 64, 175, 0.08);
        padding: 8px 10px;
        font-size: 0.75rem;
        color: var(--primary);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .model-card:hover .model-card__tooltip {
        opacity: 1;
      }

      .model-dialog__actions {
        padding: 18px 28px 28px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: linear-gradient(
          to top,
          rgba(15, 23, 42, 0.08),
          rgba(15, 23, 42, 0)
        );
      }

      .model-dialog__actions button {
        padding: 10px 20px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        cursor: pointer;
      }

      .model-dialog__actions .cancel-btn {
        background: rgba(107, 114, 128, 0.16);
        color: var(--text);
      }

      @media (prefers-color-scheme: dark) {
        .model-dialog__actions .cancel-btn {
          color: var(--text-dark);
          background: rgba(148, 163, 184, 0.22);
        }
      }

      .model-dialog__actions .confirm-btn {
        background: var(--primary);
        color: #fff;
        box-shadow: 0 10px 24px rgba(79, 70, 229, 0.24);
      }

      footer {
        margin: auto 0 24px;
        color: var(--muted);
        font-size: 0.85rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>一键抠图</h1>
      <p class="subtitle">
        将图片拖入页面任意位置，即可自动上传到抠图服务并返回透明背景图片。
        支持批量拖拽，处理完成后自动下载结果。
      </p>
      <p class="config-note">
        默认使用 BRIA RMBG v1.4 模型，权重路径指向
        <code>C:\Users\CNQ\.u2net\rmbg14.onnx</code> 并固定使用 CPU 推理。
        如切换 GPU，请在页面底部脚本中的 <code>RMBG14_PROVIDERS</code>
        常量调整为 <code>["CUDAExecutionProvider", "CPUExecutionProvider"]</code>。
      </p>
      <div class="model-selector" id="model-selector">
        <span>当前模型：<span class="current-model-label" id="current-model-label"></span></span>
        <button type="button" id="open-model-dialog">更换模型</button>
      </div>
    </header>

    <label class="drop-area" id="drop-area" for="file-input">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path
          d="M12 2a6 6 0 0 0-5.996 6.291A4.5 4.5 0 0 0 6.5 20h11a4.5 4.5 0 0 0 1.447-8.776A6.002 6.002 0 0 0 12 2Zm0 2a4 4 0 0 1 3.796 5.349 1 1 0 0 0 .665 1.297A2.5 2.5 0 0 1 17.5 18h-11a2.5 2.5 0 0 1-.619-4.922 1 1 0 0 0 .644-1.31A4 4 0 0 1 12 4Zm0 4a1 1 0 0 0-1 1v3H9l3 4 3-4h-2V9a1 1 0 0 0-1-1Z"
        />
      </svg>
      <div class="hint">拖拽或点击选择图片</div>
      <div class="tip">支持 JPG、PNG、WebP 等常见格式，批量处理自动下载</div>
      <input id="file-input" type="file" accept="image/*" multiple />
    </label>

    <section class="task-list" id="task-list"></section>

    <footer>!!仅限公司内部使用!!</footer>

    <div class="model-dialog" id="model-dialog" role="dialog" aria-modal="true">
      <div class="model-dialog__card">
        <div class="model-dialog__header">
          <h2>选择抠图模型</h2>
          <p class="subtitle">
            不同模型侧重的场景不同，悬停可查看简介，确认后将作用于后续任务。
          </p>
        </div>
        <div class="model-dialog__body">
          <div class="model-grid" id="model-grid"></div>
        </div>
        <div class="model-dialog__actions">
          <button type="button" class="cancel-btn" id="cancel-model">取消</button>
          <button type="button" class="confirm-btn" id="confirm-model">确定</button>
        </div>
      </div>
    </div>

    <script>
      // 自定义接口地址，可根据需要修改。
      const API_BASE = "http://192.168.1.5:7000/api";
      const ENDPOINT = API_BASE.replace(/\/$/, "") + "/remove";

      // Windows 服务器上 RMBG-1.4 权重默认路径，若路径有变请同步修改。
      const RMBG14_MODEL_PATH = "C:\\Users\\CNQ\\.u2net\\rmbg14.onnx";
      const RMBG14_PROVIDERS = ["CPUExecutionProvider"]; // GPU 时改为 ["CUDAExecutionProvider", "CPUExecutionProvider"]

      const DEFAULT_MODEL = "bria-rmbg14";

      const MODELS = [
        {
          id: "u2net",
          name: "U²-Net 通用-快但扣不太好",
          description: "适用多种主体抠图场景，平衡速度与质量。",
        },
       // {
       //   id: "u2netp",
       //   name: "U²-Net P 轻量",
       //   description: "体积小速度快，适合实时或批量处理。",
       // },
       // {
       //   id: "u2net_human_seg",
       //   name: "U²-Net 人像",
       //   description: "针对人物主体调优，发丝与轮廓更平滑。",
       // },
       // {
       //   id: "u2net_cloth_seg",
       //   name: "U²-Net 服饰",
       //   description: "专注衣物与商品分割，适合换装和电商场景。",
       // },
       // {
       //   id: "u2net_custom",
       //   name: "U²-Net 自定义",
       //   description: "用于加载自定义权重（需在服务器提供 model_path）。",
       // },
       // {
       //   id: "birefnet-general",
       //   name: "BiRefNet 通用",
       //   description: "高清通用模型，复杂背景下保持清晰边缘。",
       // },
       // {
       //   id: "birefnet-general-lite",
       //   name: "BiRefNet 通用 Lite",
       //   description: "BiRefNet 的加速版，性能与速度取得平衡。",
       // },
       // {
       //   id: "birefnet-portrait",
       //   name: "BiRefNet 人像",
       //   description: "针对肖像优化，保留更多细微毛发和半透明区域。",
       // },
       // {
       //   id: "birefnet-dis",
       //   name: "BiRefNet DIS 细节",
       //   description: "以高分辨率细节为目标，适合复杂边缘主体。",
       // },
       // {
       //   id: "birefnet-hrsod",
       //   name: "BiRefNet HRSOD",
       //   description: "针对大主体突出场景，显著物体分离效果佳。",
       // },
       // {
       //   id: "birefnet-cod",
       //   name: "BiRefNet COD",
       //   description: "面向伪装/隐蔽主体，复杂背景下定位更稳。",
       // },
       // {
       //   id: "birefnet-massive",
       //   name: "BiRefNet Massive",
       //   description: "最重的高保真版本，追求极致画质。",
       // },
        {
          id: "bria-rmbg14",
          name: "BRIA RMBG v1.4（CPU 默认）",
          description: "预置为 Windows CPU 推理，读取本地 rmbg14.onnx 权重。",
          extras: {
            model_path: RMBG14_MODEL_PATH,
            providers: RMBG14_PROVIDERS,
          },
        },
        {
          id: "bria-rmbg",
          name: "BRIA RMBG v2-慢，但扣的好",
          description: "来自 BRIA 的商业模型，电商与商品抠图表现稳定。",
        },
        {
          id: "isnet-general-use",
          name: "IS-Net 通用-快，扣的一般",
          description: "IS-Net 官方权重，兼顾速度与准确率。",
        },
       // {
       //   id: "isnet-anime",
       //   name: "IS-Net 动漫",
       //   description: "面向二次元/插画主体，边缘干净不毛刺。",
       // },
       // {
       //   id: "dis_custom",
       //   name: "DIS 自定义",
       //   description: "兼容自训练 DIS 模型（需在服务器提供 model_path）。",
       // },
       // {
       //   id: "ben_custom",
       //   name: "Background Eraser 自定义",
       //   description: "适配 BEN/BG Eraser 系列自定义权重。",
       // },
        {
          id: "sam",
          name: "Segment Anything (SAM)-极快，扣的非常不行",
          description: "支持 SAM 编解码流程，可配合 extras 指定提示点。",
        },
        {
          id: "silueta",
          name: "Silueta-调用使用",
          description: "轻量抠图网络，适合部署在资源受限环境。",
        },
      ];

      const AVAILABLE_MODEL_IDS = new Set(MODELS.map((item) => item.id));

      const dropArea = document.getElementById("drop-area");
      const fileInput = document.getElementById("file-input");
      const taskList = document.getElementById("task-list");
      const modelDialog = document.getElementById("model-dialog");
      const modelGrid = document.getElementById("model-grid");
      const openModelDialog = document.getElementById("open-model-dialog");
      const cancelModel = document.getElementById("cancel-model");
      const confirmModel = document.getElementById("confirm-model");
      const currentModelLabel = document.getElementById("current-model-label");

      let selectedModel = AVAILABLE_MODEL_IDS.has(DEFAULT_MODEL)
        ? DEFAULT_MODEL
        : MODELS[0]?.id || DEFAULT_MODEL;
      let pendingModel = selectedModel;

      function updateCurrentModelLabel() {
        const model = MODELS.find((item) => item.id === selectedModel);
        if (!model && MODELS.length) {
          selectedModel = MODELS[0].id;
          currentModelLabel.textContent = MODELS[0].name;
          return;
        }
        currentModelLabel.textContent = model ? model.name : selectedModel;
      }

      function renderModelOptions() {
        modelGrid.innerHTML = "";
        MODELS.forEach((model) => {
          const card = document.createElement("button");
          card.type = "button";
          card.className = "model-card";
          card.dataset.modelId = model.id;
          card.dataset.selected = model.id === pendingModel;
          card.setAttribute("aria-pressed", model.id === pendingModel ? "true" : "false");

          const title = document.createElement("div");
          title.className = "model-card__name";
          title.textContent = model.name;

          const desc = document.createElement("div");
          desc.className = "model-card__desc";
          desc.textContent = model.description;

          const tooltip = document.createElement("div");
          tooltip.className = "model-card__tooltip";
          tooltip.textContent = model.description;

          card.appendChild(title);
          card.appendChild(desc);
          card.appendChild(tooltip);

          card.addEventListener("click", () => {
            pendingModel = model.id;
            [...modelGrid.children].forEach((child) => {
              const isSelected = child.dataset.modelId === pendingModel;
              child.dataset.selected = isSelected;
              child.setAttribute("aria-pressed", isSelected ? "true" : "false");
            });
          });

          modelGrid.appendChild(card);
        });
      }

      function openModelSelector() {
        pendingModel = selectedModel;
        renderModelOptions();
        modelDialog.classList.add("visible");
      }

      function closeModelSelector() {
        modelDialog.classList.remove("visible");
      }

      openModelDialog.addEventListener("click", openModelSelector);
      cancelModel.addEventListener("click", closeModelSelector);
      confirmModel.addEventListener("click", () => {
        if (!AVAILABLE_MODEL_IDS.has(pendingModel) && MODELS.length) {
          pendingModel = MODELS[0].id;
        }
        selectedModel = pendingModel;
        updateCurrentModelLabel();
        closeModelSelector();
      });

      modelDialog.addEventListener("click", (event) => {
        if (event.target === modelDialog) {
          closeModelSelector();
        }
      });

      updateCurrentModelLabel();

      const preventDefaults = (event) => {
        event.preventDefault();
        event.stopPropagation();
      };

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        document.addEventListener(eventName, preventDefaults, false);
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        document.addEventListener(
          eventName,
          () => dropArea.classList.add("dragover"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        document.addEventListener(
          eventName,
          (event) => {
            const related = event.relatedTarget;
            if (!(related instanceof Node) || !dropArea.contains(related)) {
              dropArea.classList.remove("dragover");
            }
          },
          false
        );
      });

      document.addEventListener("drop", (event) => {
        dropArea.classList.remove("dragover");
        const files = event.dataTransfer?.files;
        if (files && files.length) {
          handleFiles(files);
        }
      });

      dropArea.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => {
        if (fileInput.files?.length) {
          handleFiles(fileInput.files);
          fileInput.value = "";
        }
      });

      function handleFiles(fileList) {
        [...fileList].forEach((file) => {
          if (!file.type.startsWith("image/")) {
            const task = createTaskItem(file);
            handleError(task, "不支持的文件类型");
            return;
          }
          processFile(file);
        });
      }

      function ensureValidModelSelection() {
        if (!AVAILABLE_MODEL_IDS.has(selectedModel) && MODELS.length) {
          selectedModel = MODELS[0].id;
          updateCurrentModelLabel();
        }
      }

      function createTaskItem(file) {
        const item = document.createElement("article");
        item.className = "task-item";

        const header = document.createElement("div");
        header.className = "task-header";

        const name = document.createElement("div");
        name.className = "task-name";
        name.textContent = file.name;

        const status = document.createElement("div");
        status.className = "task-status";
        status.textContent = "等待上传";

        header.appendChild(name);
        header.appendChild(status);

        const progressBar = document.createElement("div");
        progressBar.className = "progress-bar";
        const progressFill = document.createElement("div");
        progressFill.className = "progress-fill";
        progressBar.appendChild(progressFill);

        const downloadLink = document.createElement("a");
        downloadLink.className = "download-link";
        downloadLink.textContent = "下载结果";
        downloadLink.href = "#";
        downloadLink.download = `${file.name.replace(/\.[^.]+$/, "")}-removed.png`;

        item.appendChild(header);
        item.appendChild(progressBar);
        item.appendChild(downloadLink);

        taskList.prepend(item);

        return { item, status, progressFill, downloadLink };
      }

      function updateProgress(progressFill, percent) {
        progressFill.style.width = `${percent}%`;
      }

      function processFile(file) {
        const task = createTaskItem(file);
        ensureValidModelSelection();
        const xhr = new XMLHttpRequest();
        const formData = new FormData();
        formData.append("file", file, file.name);
        formData.append("model", selectedModel);

        const modelConfig = MODELS.find((item) => item.id === selectedModel);
        let requestUrl;
        try {
          requestUrl = new URL(ENDPOINT);
        } catch (error) {
          requestUrl = new URL(ENDPOINT, window.location.href);
        }
        if (modelConfig?.extras) {
          requestUrl.searchParams.set("extras", JSON.stringify(modelConfig.extras));
        }

        xhr.open("POST", requestUrl.toString(), true);
        xhr.responseType = "blob";

        xhr.upload.addEventListener("progress", (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 50);
            updateProgress(task.progressFill, percent);
            task.status.textContent = `上传中 ${percent}%`;
          }
        });

        xhr.upload.addEventListener("load", () => {
          updateProgress(task.progressFill, 50);
          task.status.textContent = "处理中...";
        });

        xhr.addEventListener("progress", (event) => {
          if (event.lengthComputable) {
            const percent = Math.round((event.loaded / event.total) * 50);
            const totalPercent = 50 + percent;
            updateProgress(task.progressFill, totalPercent);
            task.status.textContent = `下载中 ${totalPercent}%`;
          } else {
            task.status.textContent = "处理中...";
          }
        });

        xhr.addEventListener("load", () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            const blob = xhr.response;
            const downloadName = task.downloadLink.download;
            const initiateDownload = () => triggerDownload(blob, downloadName);

            task.downloadLink.addEventListener("click", (event) => {
              event.preventDefault();
              initiateDownload();
            });

            task.downloadLink.classList.add("visible");
            task.status.textContent = "处理完成，正在下载";

            initiateDownload();

            setTimeout(() => {
              task.status.textContent = "已完成";
              updateProgress(task.progressFill, 100);
            }, 200);
          } else {
            extractErrorMessage(xhr).then((message) => {
              handleError(task, message);
            });
          }
        });

        xhr.addEventListener("error", () => {
          handleError(task, "网络异常，稍后再试");
        });

        xhr.addEventListener("abort", () => {
          handleError(task, "上传已取消");
        });

        task.status.textContent = "准备上传";
        xhr.send(formData);
      }

      function parseErrorPayload(text) {
        if (!text) {
          return "处理失败：服务器未返回错误详情";
        }

        let message = "";

        try {
          const data = JSON.parse(text);
          if (data?.detail) {
            if (Array.isArray(data.detail)) {
              const combined = data.detail
                .map((item) => {
                  if (typeof item === "string") {
                    return item;
                  }
                  if (item?.msg && item?.loc) {
                    return `${item.msg}（${item.loc.join(" → ")}）`;
                  }
                  if (item?.msg) {
                    return item.msg;
                  }
                  return JSON.stringify(item);
                })
                .join("；");
              if (combined) {
                message = combined;
              }
            } else if (typeof data.detail === "string") {
              message = data.detail;
            }
          }

          if (!message && typeof data?.message === "string") {
            message = data.message;
          }
        } catch (error) {
          // 不是 JSON，继续尝试返回原始文本。
        }

        if (!message) {
          message = text;
        }

        if (/match pattern/i.test(message) || /regex/i.test(message)) {
          return "选择的模型不受服务端支持，请刷新页面或检查服务端配置。";
        }

        return message;
      }

      function extractErrorMessage(xhr) {
        const fallback = `处理失败：${xhr.status || 0} ${
          xhr.statusText || ""
        }`.trim();

        if (xhr.response instanceof Blob) {
          if (xhr.response.size === 0) {
            return Promise.resolve(fallback);
          }

          return xhr.response
            .text()
            .then((text) => parseErrorPayload(text.trim()))
            .catch(() => fallback);
        }

        const responseText =
          typeof xhr.responseText === "string" ? xhr.responseText.trim() : "";
        if (responseText) {
          return Promise.resolve(parseErrorPayload(responseText));
        }

        return Promise.resolve(fallback);
      }

      function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        requestAnimationFrame(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        });
      }

      function handleError(task, message) {
        task.status.textContent = message;
        task.progressFill.style.background = "#ef4444";
        task.progressFill.style.width = "100%";
      }
    </script>
  </body>
</html>
